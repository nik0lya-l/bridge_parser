import pandas as pd
import streamlit as st
import matplotlib.pyplot as plt
from datetime import datetime

# Загрузка данных
@st.cache_data
def load_data():
    df = pd.read_csv("crimea_bridge.csv")
    df['datetime'] = pd.to_datetime(df['date'] + ' ' + df['time'], format='%d.%m.%Y %H:%M')
    return df.sort_values('datetime')

df = load_data()

# Выбор направления
direction = st.radio("Выберите направление:", ["в Крым", "из Крыма"])

# Выбор даты
selected_date = st.date_input("Выберите дату:", value=df['datetime'].dt.date.max(), format="DD.MM.YYYY")

# Фильтрация по дате
filtered = df[df['datetime'].dt.date == selected_date]

if direction == "в Крым":
    count_col = 'to_crimea'
    wait_col = 'to_crimea_wait'
else:
    count_col = 'from_crimea'
    wait_col = 'from_crimea_wait'

# Преобразование значений
def to_number(val):
    try:
        return float(val)
    except:
        return None

filtered['count'] = filtered[count_col].apply(to_number)
filtered['wait'] = filtered[wait_col].apply(to_number)

# Создание графика
fig, ax1 = plt.subplots(figsize=(10, 5))

ax1.set_title(f"Движение {direction.lower()} за {selected_date.strftime('%d.%m.%Y')}")
ax1.set_xlabel("Время")
ax1.set_ylabel("Количество машин", color='blue')
ax1.plot(filtered['datetime'], filtered['count'], label="Количество машин", marker='o')
ax1.tick_params(axis='y', labelcolor='blue')

# Вторая ось — время ожидания
ax2 = ax1.twinx()
ax2.set_ylabel("Ожидание (часы)", color='red')
ax2.plot(filtered['datetime'], filtered['wait'], label="Ожидание", color='red', linestyle='--', marker='x')
ax2.tick_params(axis='y', labelcolor='red')

# Добавим вертикальные линии для событий "Мост закрыт/открыт"
for i, row in filtered.iterrows():
    if row[count_col] == "Closed":
        ax1.axvline(row['datetime'], color='black', linestyle='--', alpha=0.7)
        ax1.text(row['datetime'], ax1.get_ylim()[1]*0.9, "Мост закрыт", rotation=90, verticalalignment='top', color='black')
    elif row[count_col] == "Opened":
        ax1.axvline(row['datetime'], color='green', linestyle='--', alpha=0.7)
        ax1.text(row['datetime'], ax1.get_ylim()[1]*0.9, "Мост открыт", rotation=90, verticalalignment='top', color='green')

st.pyplot(fig)
