<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>График движения через мост</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #controls { margin-bottom: 20px; }
    label { margin-right: 10px; }
  </style>
</head>
<body>
  <h1>Движение через Крымский мост</h1>
  <div id="controls">
    <label for="direction">Направление:</label>
    <select id="direction">
      <option value="to_crimea">в Крым</option>
      <option value="from_crimea">из Крыма</option>
    </select>

    <label for="date">Дата:</label>
    <input type="date" id="date" />
  </div>
  <div id="chart"></div>

  <script>
    let rawData;

    async function loadData() {
      const response = await fetch('crimea_bridge.json');
      rawData = await response.json();
      updateChart();
    }

    function updateChart() {
      const direction = document.getElementById('direction').value;
      const selectedDate = document.getElementById('date').value;

      const filtered = rawData.filter(d => d.date === formatDate(selectedDate));

      const times = filtered.map(d => d.time);
      const datetimes = filtered.map(d => `${d.date} ${d.time}`);
      const counts = filtered.map(d => {
        const val = d[direction];
        return (val === "Closed" || val === "Opened") ? null : +val;
      });
      const waits = filtered.map(d => {
        const val = d[direction + '_wait'];
        return (val === null || val === undefined) ? null : +val;
      });

      const closedLines = filtered
        .filter(d => d[direction] === "Closed" || d[direction] === "Opened")
        .map(d => ({
          type: 'line',
          x0: `${d.date} ${d.time}`,
          x1: `${d.date} ${d.time}`,
          y0: 0,
          y1: 1,
          yref: 'paper',
          line: {
            color: d[direction] === "Closed" ? 'black' : 'green',
            width: 2,
            dash: 'dot'
          }
        }));

      const annotations = filtered
        .filter(d => d[direction] === "Closed" || d[direction] === "Opened")
        .map(d => ({
          x: `${d.date} ${d.time}`,
          y: 1.02,
          yref: 'paper',
          text: d[direction] === "Closed" ? "Мост закрыт" : "Мост открыт",
          showarrow: false,
          font: {
            color: d[direction] === "Closed" ? 'black' : 'green'
          }
        }));

      const trace1 = {
        x: datetimes,
        y: counts,
        name: 'Количество машин',
        mode: 'lines+markers',
        marker: { color: 'blue' },
        yaxis: 'y1'
      };

      const trace2 = {
        x: datetimes,
        y: waits,
        name: 'Ожидание (часы)',
        mode: 'lines+markers',
        marker: { color: 'red' },
        yaxis: 'y2'
      };

      const layout = {
        title: `Движение ${direction === 'to_crimea' ? 'в Крым' : 'из Крыма'} за ${formatDate(selectedDate)}`,
        xaxis: { title: 'Время' },
        yaxis: { title: 'Количество машин', color: 'blue' },
        yaxis2: {
          title: 'Ожидание (часы)',
          overlaying: 'y',
          side: 'right',
          color: 'red'
        },
        shapes: closedLines,
        annotations: annotations,
        margin: { t: 60 }
      };

      Plotly.newPlot('chart', [trace1, trace2], layout);
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}.${month}.${year}`;
    }

    document.getElementById('direction').addEventListener('change', updateChart);
    document.getElementById('date').addEventListener('change', updateChart);

    window.onload = () => {
      const latestDate = new Date().toISOString().split('T')[0];
      document.getElementById('date').value = latestDate;
      loadData();
    };
  </script>
</body>
</html>
