<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- Остальные части кода остаются без изменений -->
</head>
<body>
    <!-- HTML-структура остается без изменений -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ... предыдущий код без изменений ...

            function initAvailableDates(data) {
                // Создаем массив уникальных дат в формате YYYY-MM-DD
                const dateSet = new Set();
                data.forEach(item => {
                    const [day, month, year] = item.dateStr.split('.');
                    const isoDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    dateSet.add(isoDate);
                });
                
                // Сортируем даты по возрастанию
                availableDates = Array.from(dateSet).sort();
                
                // Для совместимости сохраняем и оригинальный формат DD.MM.YYYY
                availableDatesFormatted = availableDates.map(isoDate => {
                    const [year, month, day] = isoDate.split('-');
                    return `${day}.${month}.${year}`;
                });
            }

            function updateDatePicker(dateStr) {
                const dateInput = document.getElementById('date-picker');
                if (!dateInput) return;
                
                // Преобразуем DD.MM.YYYY в YYYY-MM-DD
                const [day, month, year] = dateStr.split('.');
                const isoDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                
                dateInput.value = isoDate;
                dateInput.min = availableDates[0];
                dateInput.max = availableDates[availableDates.length - 1];
            }

            function updateNavigationButtons() {
                const prevBtn = document.getElementById('prev-date');
                const nextBtn = document.getElementById('next-date');
                if (!prevBtn || !nextBtn) return;
                
                // Находим текущую дату в массиве availableDates
                const [day, month, year] = currentDate.split('.');
                const currentIsoDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                const currentIndex = availableDates.indexOf(currentIsoDate);
                
                prevBtn.disabled = currentIndex <= 0;
                nextBtn.disabled = currentIndex >= availableDates.length - 1;
            }

            async function initApp() {
                try {
                    allData = await loadData();
                    if (allData.length === 0) {
                        showError('Данные не загружены или отсутствуют.');
                        return;
                    }
                    
                    initAvailableDates(allData);
                    
                    // Устанавливаем последнюю доступную дату
                    const lastIsoDate = availableDates[availableDates.length - 1];
                    const [lastYear, lastMonth, lastDay] = lastIsoDate.split('-');
                    currentDate = `${lastDay}.${lastMonth}.${lastYear}`;
                    
                    updateDatePicker(currentDate);
                    initControls();
                    updateNavigationButtons();
                    updateChart();
                    
                    document.getElementById('content').style.display = 'block';
                } catch (error) {
                    showError(`Ошибка загрузки данных: ${error.message}`);
                    console.error(error);
                }
            }

            // Остальной код без изменений ...
        });
    </script>
</body>
</html>
